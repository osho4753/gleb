# üîç –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –û–±–º–µ–Ω–æ–≤ (Internal FIFO)

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ó–∞–¥–∞—á–∏

–°–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ–±–º–µ–Ω–æ–≤ (fiat_to_fiat) –≤ —Ä–∞—Å—á—ë—Ç PnL –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π crypto_to_fiat (–ø—Ä–æ–¥–∞–∂–∞ —Ñ–∏–∞—Ç–∞). –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç–æ—á–Ω—ã–π —É—á—ë—Ç –¥–æ—Ä–æ–≥–æ—Å—Ç–æ—è—â–µ–≥–æ (–∏–ª–∏ –¥–µ—à—ë–≤–æ–≥–æ) —Ñ–∏–∞—Ç–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π –æ–±–º–µ–Ω.

---

## ‚ú® –†–µ—à–µ–Ω–∏–µ

### 1Ô∏è‚É£ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ú–æ–¥–µ–ª–∏ Transaction

**–§–∞–π–ª:** `src/models.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã –¥–≤–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö `fiat_to_fiat`:

```python
class Transaction(BaseModel):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    cost_usdt_of_fiat_in: Optional[float] = None
    # –û–±—â–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å to_asset –≤ USDT
    # –ü—Ä–∏–º–µ—Ä: 25335 EUR –∏–º–µ–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å 28,405.502 USDT

    rate_usdt_of_fiat_in: Optional[float] = None
    # –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (to_asset/USDT)
    # –ü—Ä–∏–º–µ—Ä: 25335 EUR / 28,405.502 USDT ‚âà 0.892 EUR/USDT
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

- –•—Ä–∞–Ω–∏—Ç—å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ —Ñ–∏–∞—Ç–∞ –≤ USDT —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–µ
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–µ –ø–æ–∑–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ (Internal FIFO)

---

### 2Ô∏è‚É£ –†–∞—Å—á—ë—Ç –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–ª—è fiat_to_fiat

**–§–∞–π–ª:** `src/routers/transactions.py`, —Ñ—É–Ω–∫—Ü–∏—è `create_transaction()`

–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è `fiat_to_fiat` (–Ω–∞–ø—Ä–∏–º–µ—Ä, CZK ‚Üí EUR):

```
–®–∞–≥ 1: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è FIFO –ø–æ from_asset (CZK)
       - –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –ª–æ—Ç—ã CZK (–∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∫—É–ø–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ –∑–∞ USDT)
       - –ö–∞–∂–¥—ã–π –ª–æ—Ç –∏–º–µ–µ—Ç rate (CZK/USDT), –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å CZK –≤ USDT

–®–∞–≥ 2: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å to_asset (EUR)
       - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Å–∫–∞ CZK –∏–∑ –ª–æ—Ç–∞:
         matched_usdt = take / lot_rate
       - –°—É–º–º–∏—Ä—É—é—Ç—Å—è –≤—Å–µ matched_usdt –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è cost_usdt_total

–®–∞–≥ 3: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è rate_usdt_of_fiat_in
       - rate_usdt_of_fiat_in = amount_to_final / cost_usdt_total
       - –≠—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å EUR/USDT (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å)
```

**–ü—Ä–∏–º–µ—Ä –∏–∑ –≤–∞—à–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (Tx 12):**

```
–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- from_asset: CZK, amount_from: 619,500
- to_asset: EUR, rate_used: 24.45234
- amount_to_final: 25,335 EUR

–†–∞—Å—á—ë—Ç:
- Lot 1: 250,000 CZK —Å rate 24.5 CZK/USDT ‚Üí 10,204.08 USDT
- Lot 2: 369,500 CZK —Å rate 24.4 CZK/USDT ‚Üí 15,150.41 USDT
- cost_usdt_total = 10,204.08 + 15,150.41 = 25,354.49 USDT

- rate_usdt_of_fiat_in = 25,335 EUR / 25,354.49 USDT ‚âà 0.9992 EUR/USDT

–†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ë–î (Tx 12):
{
  "cost_usdt_of_fiat_in": 25354.49,
  "rate_usdt_of_fiat_in": 0.9992,
  "profit": -3442.8491  // PnL –ø–æ CZK
}
```

---

### 3Ô∏è‚É£ Internal FIFO –≤ crypto_to_fiat

**–§–∞–π–ª:** `src/routers/transactions.py`, —Ñ—É–Ω–∫—Ü–∏—è `create_transaction()` –¥–ª—è —Ç–∏–ø–∞ `crypto_to_fiat`

–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö —ç—Ç–∞–ø–æ–≤:

#### **–®–ê–ì 1: Lot FIFO (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º)**

```python
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π FIFO –ø–æ fiat_lots –∫–æ–ª–ª–µ–∫—Ü–∏–∏
while need > eps:
    lot = db.fiat_lots.find_one({"currency": fiat_currency, ...})
    # –ë–µ—Ä—ë–º —Ñ–∏–∞—Ç –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ –ª–æ—Ç–∞ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º PnL
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º lot_rate –∫–∞–∫ –±–∞–∑–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
```

#### **–®–ê–ì 2: Internal FIFO (–Ω–æ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∑–º)**

–ï—Å–ª–∏ –ø–æ—Å–ª–µ Lot FIFO –æ—Å—Ç–∞—ë—Ç—Å—è –¥–µ—Ñ–∏—Ü–∏—Ç (need > eps):

```python
if need > eps:  # –ï—Å—Ç—å –¥–µ—Ñ–∏—Ü–∏—Ç
    internal_txs = db.transactions.find({
        "type": "fiat_to_fiat",
        "to_asset": fiat_currency
    }, sort=[("created_at", 1)])  # FIFO - —Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏

    for internal_tx in internal_txs:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –∏–∑ —ç—Ç–æ–π internal —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        taken = sum(matches.fiat_taken_from_internal)
        remaining = internal_tx.amount_to_final - taken

        if remaining > 0:
            # –ë–µ—Ä—ë–º —Å—Ç–æ–ª—å–∫–æ, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ
            take_internal = min(remaining, internal_need)

            # –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —ç—Ç–æ–π —á–∞—Å—Ç–∏
            cost_basis_usdt = internal_tx.cost_usdt_of_fiat_in
            rate_usdt = internal_tx.rate_usdt_of_fiat_in

            # PnL = Received USDT - Cost Basis USDT
            received_usdt = take_internal / sell_rate_eff
            cost_piece_usdt = take_internal * rate_usdt
            pnl = received_usdt - cost_piece_usdt

            pnl_internal_usdt += pnl
```

---

## üìä –ü—Ä–∏–º–µ—Ä: –¶–µ–ø–æ—á–∫–∞ Tx 12 ‚Üí Tx 13

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 12 (fiat_to_fiat)

```
Input:
  type: "fiat_to_fiat"
  from_asset: "CZK"
  to_asset: "EUR"
  amount_from: 619500
  rate_used: 24.45234  # CZK/EUR

–õ–æ—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ:
  - Lot A: 250000 CZK @ rate 24.50 CZK/USDT ‚Üí 10204.08 USDT
  - Lot B: 369500 CZK @ rate 24.40 CZK/USDT ‚Üí 15145.90 USDT

Output:
  amount_to_final: 25335 EUR
  cost_usdt_of_fiat_in: 25349.98 USDT  // –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å EUR –≤ USDT
  rate_usdt_of_fiat_in: 0.9994 EUR/USDT  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å
  profit: -3442.8491 USDT  // PnL –æ—Ç CZK
```

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è 13 (crypto_to_fiat)

```
Input:
  type: "crypto_to_fiat"
  from_asset: "EUR"
  to_asset: "USDT"
  amount_from: 25335
  rate_used: 1.06  # EUR/USDT (–∫—É—Ä—Å –ø—Ä–æ–¥–∞–∂–∏)

Algorithmic Steps:

–®–∞–≥ 1 (Lot FIFO):
  - –ù–µ—Ç –æ–±—ã—á–Ω—ã—Ö fiat_lots –¥–ª—è EUR
  - –ù–∞—Ö–æ–¥–∏—Ç 0 USDT –∏–∑ Lot FIFO

–®–∞–≥ 2 (Internal FIFO):
  - –ù–∞—Ö–æ–¥–∏—Ç Tx 12: amount_to_final=25335, cost_usdt=25349.98
  - rate_usdt=0.9994
  - –ë–µ—Ä—ë—Ç –≤—Å–µ 25335 EUR –∏–∑ Tx 12

  –†–∞—Å—á—ë—Ç PnL –¥–ª—è Internal —á–∞—Å—Ç–∏:
    received_usdt = 25335 EUR / (25335/25349.98) = 25349.98 USDT
    cost_basis_usdt = 25335 * 0.9994 = 25315.10 USDT
    pnl_internal = 25349.98 - 25315.10 = +34.88 USDT

  –¢–∞–∫–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è Lot FIFO PnL = 0

Output:
  amount_to_final: 26855.1 USDT  // 25335 EUR * 1.06
  profit: +34.88 USDT  // –¢–æ–ª—å–∫–æ Internal FIFO PnL

  pnl_matches –∫–æ–ª–ª–µ–∫—Ü–∏—è:
  [
    {
      "pnl_source": "internal_fifo",
      "source_internal_tx_id": "Tx12_ID",
      "fiat_taken_from_internal": 25335,
      "matched_usdt": 25349.98,
      "cost_basis_usdt": 25315.10,
      "pnl_usdt": 34.88
    }
  ]
```

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –ù–æ–≤—ã–µ –ü–æ–ª—è –≤ transactions –∫–æ–ª–ª–µ–∫—Ü–∏–∏

```javascript
{
  "_id": ObjectId(),
  "type": "fiat_to_fiat",
  "from_asset": "CZK",
  "to_asset": "EUR",
  "amount_from": 619500,
  "amount_to_final": 25335,
  "cost_usdt_of_fiat_in": 25349.98,  // ‚ú® –ù–û–í–û–ï
  "rate_usdt_of_fiat_in": 0.9994,    // ‚ú® –ù–û–í–û–ï
  "profit": -3442.8491,
  "profit_currency": "USDT",
  "created_at": ISODate()
}
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ pnl_matches –¥–ª—è Internal FIFO

```javascript
{
  "_id": ObjectId(),
  "currency": "EUR",
  "source_internal_tx_id": "ObjectId",  // ‚ú® –ù–û–í–û–ï (–≤–º–µ—Å—Ç–æ open_lot_id)
  "close_tx_id": null,
  "fiat_taken_from_internal": 25335,
  "matched_usdt": 25349.98,
  "cost_basis_usdt": 25315.10,
  "sell_rate_eff": 1.0000591,
  "pnl_usdt": 34.88,
  "pnl_source": "internal_fifo",  // ‚ú® –ù–û–í–û–ï ('lot_fifo' –∏–ª–∏ 'internal_fifo')
  "created_at": ISODate()
}
```

---

## üîê –ì–∞—Ä–∞–Ω—Ç–∏–∏ –°–∏—Å—Ç–µ–º—ã

1. **FIFO –ü–æ—Ä—è–¥–æ–∫:** Internal Tx –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ FIFO –ø–æ—Ä—è–¥–∫–µ (`sort=[("created_at", 1)]`)

2. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –û—Å—Ç–∞—Ç–∫–æ–≤:** –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –≤–∑—è—Ç–æ –∏–∑ –∫–∞–∂–¥–æ–π Internal Tx —á–µ—Ä–µ–∑ `pnl_matches`

3. **–¢–æ—á–Ω–æ—Å—Ç—å Decimal:** –í—Å–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∞—Å—á—ë—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `Decimal` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è

4. **–ê—É–¥–∏—Ç:** –ö–∞–∂–¥–æ–µ Internal FIFO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ `pnl_matches` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

5. **–≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ Lot FIFO, –Ω–∏ Internal FIFO, —Å–∏—Å—Ç–µ–º–∞ –≤—ã–¥–∞—ë—Ç warning –Ω–æ –Ω–µ –ø–∞–¥–∞–µ—Ç

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
uvicorn src.main:app --reload

# 2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
python test_internal_fifo.py
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
‚úÖ Tx 12 —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
   cost_usdt_of_fiat_in: 25349.98 USDT ‚úì
   rate_usdt_of_fiat_in: 0.9994 EUR/USDT ‚úì

‚úÖ Tx 13 —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
   Internal FIFO matches: 1 ‚úì
   PnL (Internal): ~34.88 USDT ‚úì
```

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ó–∞–º–µ—á–∞–Ω–∏—è

### –ü–æ—á–µ–º—É Internal FIFO –Ω—É–∂–µ–Ω?

–ë–µ–∑ Internal FIFO —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Ç–µ—Ä—è–ª–∞ –±—ã –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞:

```
–°—Ü–µ–Ω–∞—Ä–∏–π –ë–ï–ó Internal FIFO:
  Tx 12: –ö—É–ø–∏–ª–∏ EUR –∑–∞ CZK (–¥–æ—Ä–æ–≥–æ) ‚Üí EUR –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ USDT
  Tx 13: –ü—Ä–æ–¥–∞–ª–∏ EUR ‚Üí –°–∏—Å—Ç–µ–º–∞ –ù–ï –∑–Ω–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
         –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π PnL

–°—Ü–µ–Ω–∞—Ä–∏–π –° Internal FIFO:
  Tx 12: –°–æ—Ö—Ä–∞–Ω–∏–ª–∏ cost_usdt_of_fiat_in –∏ rate_usdt_of_fiat_in
  Tx 13: –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ PnL
         –†–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π PnL ‚úì
```

### –û—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ Lot FIFO

```
Lot FIFO:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–∞—Ç–Ω—ã–µ –ª–æ—Ç—ã, —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ fiat_to_crypto
  - –ö–∞–∂–¥—ã–π –ª–æ—Ç –∏–º–µ–µ—Ç rate (FIAT/USDT)
  - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —á–µ—Ä–µ–∑ crypto_to_fiat

Internal FIFO:
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã fiat_to_fiat —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  - –ò–º–µ–µ—Ç cost_usdt_of_fiat_in –∏ rate_usdt_of_fiat_in
  - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –∫–æ–≥–¥–∞ Lot FIFO –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—á—ë—Ç –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –æ–±–º–µ–Ω–æ–≤
```

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ Production

–ü–µ—Ä–µ–¥ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ–º —É–±–µ–¥–∏—Ç–µ—Å—å:

1. ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
2. ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤ `D()` –≤–Ω–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏)
3. ‚úÖ MongoDB –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ `created_at` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ FIFO
4. ‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ë–î –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π
5. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ønL —Ä–∞—Å—á—ë—Ç–æ–≤ (–¥–ª—è –∞—É–¥–∏—Ç–∞)

---

## üìö –§–∞–π–ª—ã, –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ò–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

| –§–∞–π–ª                          | –°—Ç—Ä–æ–∫–∏  | –ò–∑–º–µ–Ω–µ–Ω–∏—è                                            |
| ----------------------------- | ------- | ---------------------------------------------------- |
| `src/models.py`               | 12-13   | –î–æ–±–∞–≤–ª–µ–Ω—ã cost_usdt_of_fiat_in, rate_usdt_of_fiat_in |
| `src/routers/transactions.py` | 157-188 | –û–±–Ω–æ–≤–ª—ë–Ω —Ä–∞—Å—á—ë—Ç cost_usdt –≤ fiat_to_fiat             |
| `src/routers/transactions.py` | 199-293 | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Internal FIFO –≤ crypto_to_fiat            |

---

**‚ú® –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production!**

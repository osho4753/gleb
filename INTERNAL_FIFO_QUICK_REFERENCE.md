# üéØ –ö—Ä–∞—Ç–∫–∞—è –°–ø—Ä–∞–≤–∫–∞: Internal FIFO

## ‚ùì –ß—Ç–æ –ë—ã–ª–æ –î–æ–±–∞–≤–ª–µ–Ω–æ?

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫–∏ –æ–±–º–µ–Ω–æ–≤:

```
Tx 12: CZK ‚îÄ‚îÄ(fiat_to_fiat)‚îÄ‚îÄ> EUR
         ‚Üì
       –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
         ‚Üì
Tx 13: EUR ‚îÄ‚îÄ(crypto_to_fiat)‚îÄ‚îÄ> USDT
         ‚Üì
       –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ Tx 12
         ‚Üì
    –¢–æ—á–Ω—ã–π PnL ‚úì
```

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –ü–æ–ª—è –≤ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö

### –î–ª—è fiat_to_fiat –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:

```json
{
  "type": "fiat_to_fiat",
  "from_asset": "CZK",
  "to_asset": "EUR",
  "amount_to_final": 25335,

  "cost_usdt_of_fiat_in": 25349.98,
  "rate_usdt_of_fiat_in": 0.9994,

  "profit": -3442.8491,
  "profit_currency": "USDT"
}
```

**cost_usdt_of_fiat_in:**

- –û–±—â–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å to_asset (EUR) –≤ USDT —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–µ
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ FIFO –ª–æ—Ç–æ–≤ from_asset (CZK)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ EUR

**rate_usdt_of_fiat_in:**

- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫—É—Ä—Å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (EUR/USDT)
- = amount_to_final / cost_usdt_of_fiat_in
- –ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–∞—Ö

---

## üìä –ü—Ä–∏–º–µ—Ä –∏–∑ –í–∞—à–µ–π –°–∏—Å—Ç–µ–º—ã

### –í—Ö–æ–¥–Ω—ã–µ –î–∞–Ω–Ω—ã–µ

```
–õ–æ—Ç—ã –≤ —Å–∏—Å—Ç–µ–º–µ:
  Lot 1: 250,000 CZK @ 24.50 CZK/USDT = 10,204.08 USDT
  Lot 2: 369,500 CZK @ 24.40 CZK/USDT = 15,145.90 USDT
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  –ò—Ç–æ–≥–æ: 619,500 CZK = 25,349.98 USDT

–û–±–º–µ–Ω EUR/CZK:
  619,500 CZK √∑ 24.45234 = 25,335 EUR
```

### –†–∞—Å—á—ë—Ç

```
cost_usdt_of_fiat_in = 25,349.98 USDT
rate_usdt_of_fiat_in = 25,335 EUR √∑ 25,349.98 USDT = 0.9994 EUR/USDT
```

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

1 EUR –æ–±—Ö–æ–¥–∏—Ç—Å—è –≤ 0.9994 USDT (–¥–µ—à–µ–≤–ª–µ 1 USDT!)

- –≠—Ç–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ CZK –±—ã–ª –¥–µ—à—ë–≤—ã–º –Ω–∞ –º–æ–º–µ–Ω—Ç –µ–≥–æ –ø–æ–∫—É–ø–∫–∏

–ü—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ EUR:

```
–ï—Å–ª–∏ –ø—Ä–æ–¥–∞—Ç—å 25,335 EUR @ 1.06 EUR/USDT = 26,855.1 USDT
–ù–æ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –±—ã–ª–∞ = 25,349.98 USDT
PnL = 26,855.1 - 25,349.98 = +1,505.12 USDT –ø—Ä–∏–±—ã–ª—å
```

---

## üîÑ –ö–∞–∫ –†–∞–±–æ—Ç–∞–µ—Ç Internal FIFO?

```
–ö–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç crypto_to_fiat (–ø—Ä–æ–¥–∞–∂–∞ EUR):

1Ô∏è‚É£ –°–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç –æ–±—ã—á–Ω—ã–µ fiat_lots (–∏–∑ fiat_to_crypto)
   –ï—Å–ª–∏ —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí –≥–æ—Ç–æ–≤–æ

2Ô∏è‚É£ –ï—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Üí –∏—â–µ—Ç fiat_to_fiat —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –í –ø–æ—Ä—è–¥–∫–µ FIFO (–æ—Ç —Å—Ç–∞—Ä–æ–π –∫ –Ω–æ–≤–æ–π)
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç cost_usdt_of_fiat_in
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç rate_usdt_of_fiat_in –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ PnL

3Ô∏è‚É£ –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç PnL –∏–∑ –æ–±–æ–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
```

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Collections

### transactions

```javascript
{
  // ... —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–ª—è ...
  "type": "fiat_to_fiat",
  "cost_usdt_of_fiat_in": Number,  // ‚ú® –Ω–æ–≤–æ–µ
  "rate_usdt_of_fiat_in": Number   // ‚ú® –Ω–æ–≤–æ–µ
}
```

### pnl_matches

```javascript
{
  "pnl_source": "lot_fifo" | "internal_fifo",  // ‚ú® –Ω–æ–≤–æ–µ
  "source_internal_tx_id": ObjectId,            // ‚ú® –Ω–æ–≤–æ–µ (–¥–ª—è internal)
  "fiat_taken_from_internal": Number,           // ‚ú® –Ω–æ–≤–æ–µ (–¥–ª—è internal)
  "cost_basis_usdt": Number,                    // ‚ú® –Ω–æ–≤–æ–µ (–¥–ª—è internal)
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Quick Test

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä
cd back
uvicorn src.main:app --reload

# 2. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
python test_internal_fifo.py
```

### –ß—Ç–æ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¢–µ—Å—Ç

‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ Tx 12 —Å cost_usdt_of_fiat_in  
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ Tx 13 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Internal FIFO  
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–∞ PnL  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ pnl_matches

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ó–∞–º–µ—á–∞–Ω–∏—è

### 1. –¢–æ—á–Ω–æ—Å—Ç—å Decimal

–í—Å–µ —Ä–∞—Å—á—ë—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `Decimal` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –æ—à–∏–±–æ–∫:

```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
from decimal import Decimal
value = Decimal("25335.00")

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
value = 25335.0  # Float –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–∞–º
```

### 2. FIFO –ü–æ—Ä—è–¥–æ–∫

–°–∏—Å—Ç–µ–º–∞ —É–≤–∞–∂–∞–µ—Ç —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫:

```python
# –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è sort=[("created_at", 1)] –¥–ª—è FIFO
```

### 3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –û—Å—Ç–∞—Ç–∫–æ–≤

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ EUR –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∏–∑ –∫–∞–∂–¥–æ–π fiat_to_fiat Tx:

```
–ï—Å–ª–∏ Tx 12 —Å–æ–∑–¥–∞–ª 25,335 EUR –∏ –Ω—É–∂–Ω–æ 30,000 EUR:
- –ë–µ—Ä—ë—Ç 25,335 EUR –∏–∑ Tx 12
- –ò—â–µ—Ç –¥—Ä—É–≥—É—é fiat_to_fiat Tx –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö 4,665 EUR
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ö–∞–∫ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cost_usdt –≤ –ë–î?

```javascript
// MongoDB
db.transactions.findOne({ type: 'fiat_to_fiat' }, { cost_usdt_of_fiat_in: 1 })
```

### –ö–∞–∫ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Internal FIFO –ú–∞—Ç—á–∏?

```javascript
// MongoDB
db.pnl_matches.find({ pnl_source: 'internal_fifo' })
```

### –ö–∞–∫ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PnL?

```javascript
// –û–±—â–µ–µ PnL –¥–ª—è EUR
db.transactions.aggregate([
  { $match: { to_asset: 'EUR', type: 'fiat_to_fiat' } },
  { $group: { _id: null, total_pnl: { $sum: '$profit' } } },
])
```

---

## üìû –ï—Å–ª–∏ –ß—Ç–æ-—Ç–æ –ù–µ –†–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ–±–ª–µ–º–∞: cost_usdt_of_fiat_in = None

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –ª–æ—Ç–æ–≤ for from_asset  
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏ fiat_to_crypto –ø–µ—Ä–µ–¥ fiat_to_fiat

### –ü—Ä–æ–±–ª–µ–º–∞: PnL –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤ Tx 13

**–ü—Ä–∏—á–∏–Ω–∞:** Internal FIFO –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–¥ –≤ crypto_to_fiat —Å–æ–¥–µ—Ä–∂–∏—Ç Internal FIFO –ª–æ–≥–∏–∫—É

### –ü—Ä–æ–±–ª–µ–º–∞: MongoDB –æ—à–∏–±–∫–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ò–Ω–¥–µ–∫—Å –Ω–∞ created_at –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç  
**–†–µ—à–µ–Ω–∏–µ:**

```javascript
db.transactions.createIndex({ created_at: 1 })
db.fiat_lots.createIndex({ created_at: 1 })
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `INTERNAL_FIFO_DOCUMENTATION.md`
- **–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:** `test_internal_fifo.py`
- **–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:** `src/routers/transactions.py` (—Å—Ç—Ä–æ–∫–∏ 157-293)

---

**‚ú® –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**
